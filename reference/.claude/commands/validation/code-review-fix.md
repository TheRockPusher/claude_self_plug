---
description: Fix issues identified by code-review command
allowed-tools:
  - Read
  - Edit
  - Write
  - Glob
  - Grep
  - Bash(git status:*)
  - Bash(git diff:*)
  - Bash(npm run lint:*)
  - Bash(npm run test:*)
  - Bash(npx tsc:*)
  - Bash(npx eslint:*)
  - Bash(python -m pytest:*)
  - Bash(python -m mypy:*)
  - Bash(python -m ruff:*)
  - Bash(cargo test:*)
  - Bash(cargo clippy:*)
  - Bash(cargo check:*)
  - Bash(make:*)
  - TodoWrite
  - AskUserQuestion
argument-hint: <review-file> <scope> — scopes: all | critical | blocking | major | minor | suggestions | nits | <ISSUE-ID>
model: sonnet
---

# Code Review Fix: Apply Corrections

## Objective

Read a code review file generated by `/code-review` and apply fixes based on the
specified scope. Track progress with TodoWrite and verify fixes with validation tools.

## Arguments

Parse `$ARGUMENTS` to determine:

1. **review-file** (required): Path to the review file
   - Example: `.agents/code-reviews/review-2025-01-15-143022.md`

2. **scope** (required): What to fix

| Scope | Description |
| ----- | ----------- |
| `all` | Fix all issues (critical → nits, in order) |
| `critical` | Fix only critical severity issues |
| `blocking` | Fix critical + blocking issues |
| `major` | Fix critical + blocking + major issues |
| `minor` | Fix up to minor issues |
| `suggestions` | Fix up to suggestions |
| `nits` | Fix everything including nits |
| `SEC-001` | Fix specific issue by ID (e.g., SEC-001, LOGIC-003) |
| `security` | Fix all issues in security category |
| `logic` | Fix all issues in logic category |
| `performance` | Fix all issues in performance category |
| `quality` | Fix all issues in quality category |
| `patterns` | Fix all issues in patterns category |

---

## Phase 1: Load Review Context

### Step 1: Read the review file

```text
Read($review-file)
```

Parse the review file to extract:

- List of all issues with their IDs, severities, categories
- File paths and line numbers for each issue
- Suggested fixes from the review
- Validation commands used (from Validation Results section)

### Step 2: Filter issues by scope

Based on the scope argument, create a filtered list of issues to fix.

Severity hierarchy (most to least severe):

1. critical
2. blocking (high)
3. major
4. minor
5. suggestion
6. nit

When scope is a severity level, include all issues at that level and above.

### Step 3: Create fix plan with TodoWrite

Add each issue to fix as a todo item:

```text
TodoWrite([
  { content: "Fix SEC-001: SQL injection in auth.py:42", status: "pending" },
  { content: "Fix LOGIC-002: Off-by-one in parser.py:156", status: "pending" },
  ...
])
```

Order todos by severity (critical first, nits last).

---

## Phase 2: Apply Fixes

For each issue in the filtered list:

### Step 1: Mark todo as in progress

```text
TodoWrite([...update status to "in_progress"...])
```

### Step 2: Read the target file

```text
Read(file_path)
```

Understand the full context around the issue, not just the flagged line.

### Step 3: Apply the fix

Use the suggestion from the review as guidance, but:

- **Verify the suggestion is correct** — review suggestions may need adaptation
- **Preserve existing functionality** — fix the issue without breaking other code
- **Follow codebase conventions** — match style from CLAUDE.md
- **Handle edge cases** — the fix should be complete, not partial

Use Edit tool to apply changes:

```text
Edit(file_path, old_string, new_string)
```

### Step 4: Mark todo as complete

```text
TodoWrite([...update status to "completed"...])
```

### Step 5: Move to next issue

Repeat for all issues in scope.

---

## Phase 3: Validation

After all fixes are applied:

### Step 1: Run validation tools

Execute the same validation commands from the original review:

```bash
# Examples based on project type
make check
npm run lint
ruff check .
cargo clippy
```

### Step 2: Check for regressions

```bash
git diff --stat
```

Review changes to ensure:

- Only intended files were modified
- No unrelated changes introduced
- Fix doesn't break other functionality

### Step 3: Run tests if available

```bash
# Based on project
npm run test
python -m pytest
cargo test
```

---

## Phase 4: Report

Generate a fix summary:

```markdown
# Code Review Fix Report

**Review file:** .agents/code-reviews/review-YYYY-MM-DD-HHMMSS.md
**Scope:** [scope argument]
**Timestamp:** YYYY-MM-DD HH:MM:SS

---

## Issues Fixed

| ID | Category | File | Status |
|----|----------|------|--------|
| SEC-001 | security | auth.py:42 | ✅ Fixed |
| LOGIC-002 | logic | parser.py:156 | ✅ Fixed |
| PERF-001 | performance | query.py:89 | ⚠️ Partial (see notes) |

## Issues Skipped

| ID | Category | Reason |
|----|----------|--------|
| NIT-003 | patterns | Out of scope |

## Validation Results

- `make check` — ✅ Passed
- `npm run test` — ✅ Passed (42 tests)

## Files Modified

- `src/auth.py` — 2 changes
- `src/parser.py` — 1 change
- `src/query.py` — 1 change

## Notes

- PERF-001: Applied optimisation but requires manual verification of query performance
- Consider running full test suite before merging

## Next Steps

To commit these fixes, run: `/commit`

To re-review the fixed code, run: `/code-review branch`
```

---

## Important Notes

- **One fix at a time** — Apply and verify each fix before moving to the next
- **Preserve behaviour** — Fixes should not change intended functionality
- **Verify suggestions** — Review recommendations may need adaptation to context
- **Track progress** — Use TodoWrite to maintain visibility into fix progress
- **Run validation** — Always run project validation after fixes
- **Document partial fixes** — If a fix is incomplete, note why in the report

---

## Example Usage

```bash
# Fix all critical and blocking issues
/code-review-fix .agents/code-reviews/review-2025-01-15-143022.md blocking

# Fix a specific issue
/code-review-fix .agents/code-reviews/review-2025-01-15-143022.md SEC-001

# Fix all security-related issues
/code-review-fix .agents/code-reviews/review-2025-01-15-143022.md security

# Fix everything
/code-review-fix .agents/code-reviews/review-2025-01-15-143022.md all
```

ultrathink
